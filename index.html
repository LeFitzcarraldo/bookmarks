<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookmarks App Pro</title>
    <style>
        /* --- CSS (Sin cambios respecto a la versi√≥n anterior 'full') --- */
        :root {
            --bg-color: #121212; --text-color: #e0e0e0; --card-bg: #1e1e1e;
            --card-border: #444; --link-color: #64b5f6; --desc-color: #b0b0b0;
            --form-bg: #2a2a2a; --input-bg: #333; --input-border: #555;
            --col1-bg: #003c44; --col1-border: #005f6b; --col2-bg: #1b4b2a;
            --col2-border: #2e7d32; --col3-bg: #5c002f; --col3-border: #8e0048;
            --btn-delete-bg: #c62828; --btn-edit-bg: #555; --btn-edit-hover: #777;
            --btn-submit-bg: #388e3c; --btn-submit-hover: #2e7d32;
            --heading-color: #ffffff; --column-header-color: #c0c0c0;
            --column-header-editing-bg: #444; --btn-add-column-bg: #4a4a4a;
            --btn-add-column-hover: #5a5a5a; --modal-bg: rgba(0, 0, 0, 0.7);
            --modal-content-bg: #252525; --drag-over-border: 2px dashed var(--link-color);
            --pinned-color: #ffeb3b; /* Color para pin */
        }
        body { font-family: sans-serif; margin: 0; padding: 20px; background-color: var(--bg-color); color: var(--text-color); }
        .main-header { display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 15px; margin-bottom: 15px; padding: 0 10px; }
        .main-header h1 { grid-column: 2 / 3; text-align: center; margin: 0; color: var(--heading-color); }
        .header-actions { grid-column: 3 / 4; justify-self: end; display: flex; gap: 10px; }
        .header-actions button, .header-actions label { background-color: var(--btn-add-column-bg); color: var(--text-color); border: 1px solid var(--input-border); padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s; white-space: nowrap; }
        .header-actions button:hover, .header-actions label:hover { background-color: var(--btn-add-column-hover); }
        #import-file { display: none; }
        .search-container { margin: 15px auto; max-width: 600px; }
        #search-box { width: 95%; padding: 10px; border: 1px solid var(--input-border); border-radius: 4px; background-color: var(--input-bg); color: var(--text-color); font-size: 1em; display: block; margin: auto; }
        h2 { text-align: center; color: var(--heading-color); margin-top: 25px; }
        .columns-container { display: flex; gap: 20px; flex-wrap: wrap; margin-top: 20px; margin-bottom: 30px; }
        .column { flex: 1; min-width: 280px; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.4); min-height: 300px; border: 1px solid; background-color: var(--col-bg); transition: background-color 0.3s; display: flex; flex-direction: column; position: relative; }
        .column-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed var(--card-border); margin-bottom: 15px; padding-bottom: 10px; }
        .column h3 { margin: 0; text-align: left; color: var(--column-header-color); padding: 5px; cursor: pointer; transition: background-color 0.2s; border-radius: 4px; min-height: 1.2em; flex-grow: 1; }
        .column h3:hover, .column h3:focus { background-color: var(--column-header-editing-bg); }
        .column h3[contenteditable="true"] { outline: 1px solid var(--link-color); cursor: text; }
        .delete-column-btn { background: none; border: none; color: var(--btn-delete-bg); font-size: 1.2em; font-weight: bold; cursor: pointer; padding: 0 5px; margin-left: 8px; opacity: 0.7; transition: opacity 0.2s; }
        .delete-column-btn:hover { opacity: 1; }
        .bookmarks-list { flex-grow: 1; overflow-y: auto; min-height: 100px; padding: 5px 0; }
        .column-blue { --col-bg: var(--col1-bg); border-color: var(--col1-border); }
        .column-green { --col-bg: var(--col2-bg); border-color: var(--col2-border); }
        .column-red { --col-bg: var(--col3-bg); border-color: var(--col3-border); }
        .bookmark-item { background-color: var(--card-bg); border: 1px solid var(--card-border); border-radius: 5px; padding: 10px 15px; margin-bottom: 10px; position: relative; word-wrap: break-word; transition: background-color 0.3s, border-color 0.3s, opacity 0.2s; cursor: grab; user-select: none; display: flex; align-items: flex-start; gap: 8px; }
        .bookmark-item.dragging { opacity: 0.5; }
        .bookmark-item.drag-over { border-bottom: var(--drag-over-border); margin-bottom: calc(10px - 2px); }
        .bookmark-item.hidden-by-search { display: none; }
        .bookmark-item.pinned { border-left: 4px solid var(--pinned-color); background-color: #2a2a2a; }
        .bookmark-favicon { width: 16px; height: 16px; flex-shrink: 0; margin-top: 4px; }
        .bookmark-content { flex-grow: 1; }
        .bookmark-content h4 { margin: 0 0 5px 0; color: var(--link-color); }
        .bookmark-content a { color: var(--link-color); text-decoration: none; font-weight: bold; }
        .bookmark-content a:hover { text-decoration: underline; }
        .bookmark-content p { font-size: 0.9em; color: var(--desc-color); margin: 5px 0 0 0; }
        .bookmark-actions { position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; }
        .bookmark-actions button { background: none; border: none; color: var(--text-color); font-size: 1em; cursor: pointer; padding: 2px; line-height: 1; opacity: 0.7; transition: opacity 0.2s, color 0.2s; }
        .bookmark-actions button:hover { opacity: 1; }
        .edit-bookmark-btn { color: var(--btn-edit-bg); } .edit-bookmark-btn:hover { color: var(--btn-edit-hover); }
        .delete-bookmark-btn { color: var(--btn-delete-bg); }
        .pin-bookmark-btn { color: #ccc; }
        .pin-bookmark-btn.pinned-active { color: var(--pinned-color); }
        #add-bookmark-form { background-color: var(--form-bg); color: var(--text-color); padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.4); margin-bottom: 30px; max-width: 600px; margin-left: auto; margin-right: auto; transition: background-color 0.3s; }
        #add-bookmark-form label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--text-color); }
        #add-bookmark-form input, #add-bookmark-form textarea, #add-bookmark-form select { width: 95%; padding: 10px; margin-bottom: 15px; border: 1px solid var(--input-border); border-radius: 4px; font-size: 1em; background-color: var(--input-bg); color: var(--text-color); transition: background-color 0.3s, border-color 0.3s, color 0.3s; }
        #add-bookmark-form textarea { resize: vertical; min-height: 60px; }
        #add-bookmark-form button { background-color: var(--btn-submit-bg); color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; transition: background-color 0.2s; }
        #add-bookmark-form button:hover { background-color: var(--btn-submit-hover); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: var(--modal-bg); }
        .modal-content { background-color: var(--modal-content-bg); margin: 10% auto; padding: 25px; border: 1px solid var(--input-border); width: 80%; max-width: 500px; border-radius: 8px; position: relative; }
        .modal-close-btn { color: var(--text-color); position: absolute; top: 10px; right: 15px; font-size: 1.8em; font-weight: bold; cursor: pointer; line-height: 1; }
        .modal-close-btn:hover, .modal-close-btn:focus { color: var(--btn-delete-bg); text-decoration: none; }
        .modal h2 { margin-top: 0; margin-bottom: 20px; }
        .modal label { display: block; margin-bottom: 5px; font-weight: bold; }
        .modal input, .modal textarea { width: 95%; padding: 10px; margin-bottom: 15px; border: 1px solid var(--input-border); border-radius: 4px; font-size: 1em; background-color: var(--input-bg); color: var(--text-color); }
        .modal textarea { resize: vertical; min-height: 80px; }
        .modal button { background-color: var(--btn-submit-bg); color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; transition: background-color 0.2s; }
        .modal button:hover { background-color: var(--btn-submit-hover); }
        .modal button[type="button"] { background-color: var(--btn-edit-bg); margin-left: 10px; }
        .modal button[type="button"]:hover { background-color: var(--btn-edit-hover); }
        .instructions { background-color: #333; color: #f1c40f; border: 1px solid #555; padding: 15px; border-radius: 5px; margin-bottom: 20px; text-align: center; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }
    </style>
</head>
<body>

    <header class="main-header">
        <div></div> <h1>Bookmarks</h1>
        <div class="header-actions">
             <button id="export-btn" type="button">Exportar</button>
             <label for="import-file" id="import-btn">Importar</label>
             <input type="file" id="import-file" accept=".json">
             <button id="add-column-btn" type="button">Agregar Columna</button>
        </div>
    </header>

     <div class="search-container">
         <input type="search" id="search-box" placeholder="Buscar por t√≠tulo o descripci√≥n...">
     </div>

    <div class="instructions">
        <strong>Nota:</strong> Datos guardados localmente. üìå Fija bookmarks importantes. ‚úé Edita. üóëÔ∏è Elimina. Arrastra para reordenar.
    </div>

    <div id="add-bookmark-form">
         <h2>Agregar Nuevo Bookmark</h2>
         <form id="bookmark-form">
              <div><label for="bookmark-url">URL:</label><input type="url" id="bookmark-url" required></div>
              <div><label for="bookmark-title">T√≠tulo:</label><input type="text" id="bookmark-title" required></div>
              <div><label for="bookmark-desc">Descripci√≥n:</label><textarea id="bookmark-desc"></textarea></div>
              <div><label for="bookmark-column">Columna:</label><select id="bookmark-column" required></select></div>
              <button type="submit">Agregar Bookmark</button>
         </form>
    </div>

    <div class="columns-container"></div>

    <div id="edit-bookmark-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn" aria-label="Cerrar">&times;</span>
            <h2>Editar Bookmark</h2>
            <form id="edit-bookmark-form">
                <input type="hidden" id="edit-bookmark-id">
                <div><label for="edit-bookmark-url">URL:</label><input type="url" id="edit-bookmark-url" required></div>
                <div><label for="edit-bookmark-title">T√≠tulo:</label><input type="text" id="edit-bookmark-title" required></div>
                <div><label for="edit-bookmark-desc">Descripci√≥n:</label><textarea id="edit-bookmark-desc"></textarea></div>
                <button type="submit">Guardar Cambios</button>
                <button type="button" class="modal-cancel-btn">Cancelar</button>
            </form>
        </div>
    </div>


    <script>
        const APP_STORAGE_KEY = 'bookmarksAppData_v5_full';
        const COLUMN_COLORS = ['column-blue', 'column-green', 'column-red'];
        let columnColorIndex = 0;
        let appState = { columns: [], bookmarks: [] };
        let draggedItem = null;

        // --- Inicializaci√≥n ---
        document.addEventListener('DOMContentLoaded', () => {
            loadAppState();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Formularios
            document.getElementById('bookmark-form').addEventListener('submit', handleAddBookmark);
            document.getElementById('edit-bookmark-form').addEventListener('submit', handleEditBookmarkSubmit);
            // Acciones Header
            document.getElementById('add-column-btn').addEventListener('click', handleAddColumn);
            document.getElementById('export-btn').addEventListener('click', handleExport);
            document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-file').click());
            document.getElementById('import-file').addEventListener('change', handleImportFileChange);
            // B√∫squeda
            document.getElementById('search-box').addEventListener('input', handleSearch);
            // Contenedor Columnas (Clicks y D&D)
            const columnsContainer = document.querySelector('.columns-container');
            columnsContainer.addEventListener('click', handleColumnClick);
            columnsContainer.addEventListener('dblclick', handleColumnTitleDblClick);
            columnsContainer.addEventListener('blur', handleTitleEditEnd, true);
            columnsContainer.addEventListener('keydown', handleTitleEditKeydown, true);
            columnsContainer.addEventListener('dragstart', handleDragStart);
            columnsContainer.addEventListener('dragend', handleDragEnd);
            columnsContainer.addEventListener('dragover', handleDragOver);
            columnsContainer.addEventListener('dragenter', handleDragEnter);
            columnsContainer.addEventListener('dragleave', handleDragLeave);
            columnsContainer.addEventListener('drop', handleDrop);
            // Modal
            const modal = document.getElementById('edit-bookmark-modal');
            modal.querySelector('.modal-close-btn').addEventListener('click', closeModal);
            modal.querySelector('.modal-cancel-btn').addEventListener('click', closeModal);
            window.addEventListener('click', (event) => { if (event.target == modal) closeModal(); });
        }

        // --- Carga y Guardado del Estado ---
        function loadAppState() {
             console.log('--- Iniciando loadAppState ---'); // LOG
             const savedData = localStorage.getItem(APP_STORAGE_KEY);
             console.log('Datos guardados crudos:', savedData); // LOG
             if (savedData) {
                 try {
                     appState = JSON.parse(savedData);
                     if (!appState.columns) appState.columns = [];
                     if (!appState.bookmarks) appState.bookmarks = [];
                     appState.bookmarks.forEach(bm => {
                         if (bm.isPinned === undefined) bm.isPinned = false;
                         delete bm.parentId;
                     });
                 } catch (e) { console.error("Error al parsear datos guardados:", e); setDefaultState(); }
             } else {
                 console.log("No hay datos guardados, usando estado por defecto."); // LOG
                 setDefaultState();
             }
             columnColorIndex = appState.columns.length % COLUMN_COLORS.length;
             console.log('Estado ANTES de ordenar y renderizar:', JSON.stringify(appState)); // LOG
             sortAppStateBookmarks(); // Ordenar antes de renderizar
             renderApp();
        }
        function setDefaultState() {
             columnColorIndex = 0;
             appState = {
                 columns: [
                     { id: `col-${Date.now()}-1`, title: "General", colorClass: COLUMN_COLORS[0] },
                     { id: `col-${Date.now()}-2`, title: "Trabajo", colorClass: COLUMN_COLORS[1] },
                     { id: `col-${Date.now()}-3`, title: "Ocio", colorClass: COLUMN_COLORS[2] }
                 ],
                 bookmarks: []
             };
             columnColorIndex = appState.columns.length % COLUMN_COLORS.length;
             console.log("Estado inicial por defecto establecido."); // LOG
        }
        function saveAppState() {
            appState.columns.forEach(column => {
                const colEl = document.getElementById(column.id);
                if(colEl) {
                    const titleEl = colEl.querySelector('h3');
                    if(titleEl) column.title = titleEl.textContent.trim() || "Sin T√≠tulo";
                }
            });
            // El orden de bookmarks ya deber√≠a estar correcto en appState por sort y sync
            localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(appState));
            console.log("Estado guardado.");
        }
         // --- Ordenamiento (para Pinned) ---
         function sortAppStateBookmarks() {
             appState.bookmarks.sort((a, b) => {
                 const colIndexA = appState.columns.findIndex(c => c.id === a.columnId);
                 const colIndexB = appState.columns.findIndex(c => c.id === b.columnId);
                 if (colIndexA !== colIndexB) return colIndexA - colIndexB;
                 if (a.isPinned && !b.isPinned) return -1;
                 if (!a.isPinned && b.isPinned) return 1;
                 return 0; // Mantener orden relativo si ambos son pinned o no-pinned
             });
             // console.log("Bookmarks ordenados por pin."); // Opcional: Descomentar para debug
         }

        // --- Renderizado ---
        function renderApp() {
             console.log('--- Iniciando renderApp ---'); // LOG
             // El estado ya est√° ordenado por `loadAppState`
             renderColumns();
             renderAllBookmarksInOrder();
             updateBookmarkColumnDropdown(); // <-- Llamar aqu√≠
             applySearchFilter();
        }
        function renderColumns() {
            console.log('--- Iniciando renderColumns. Columnas:', appState.columns.length); // LOG
            const columnsContainer = document.querySelector('.columns-container');
            columnsContainer.innerHTML = '';
             appState.columns.forEach(columnData => {
                 columnsContainer.appendChild(createColumnElement(columnData));
             });
        }
        function createColumnElement(columnData) { /* ... sin cambios ... */ } // C√≥digo igual que versi√≥n anterior
        function renderAllBookmarksInOrder() {
            console.log('--- Iniciando renderAllBookmarksInOrder. Bookmarks:', appState.bookmarks.length); // LOG
            document.querySelectorAll('.bookmarks-list').forEach(list => list.innerHTML = '');
             appState.bookmarks.forEach(bookmark => {
                 const column = document.getElementById(bookmark.columnId);
                 const bookmarksList = column?.querySelector('.bookmarks-list');
                 if (bookmarksList) {
                     bookmarksList.appendChild(createBookmarkElement(bookmark));
                 } else { /* ... advertencia ... */ }
             });
        }
        function createBookmarkElement(bookmark) { /* ... sin cambios ... */ } // C√≥digo igual que versi√≥n anterior
        function updateBookmarkColumnDropdown() { // ** Versi√≥n Mejorada **
            console.log('--- Iniciando updateBookmarkColumnDropdown. Columnas:', appState.columns.length); // LOG
            const selectElement = document.getElementById('bookmark-column');
            selectElement.innerHTML = ''; // Limpiar

            if (!appState.columns || appState.columns.length === 0) { // Comprobar nulidad tambi√©n
                console.log("No hay columnas para el dropdown."); // LOG
                const placeholderOption = document.createElement('option');
                placeholderOption.value = "";
                placeholderOption.textContent = "No hay columnas disponibles";
                placeholderOption.disabled = true;
                placeholderOption.selected = true;
                selectElement.appendChild(placeholderOption);
                selectElement.disabled = true;
            } else {
                console.log(`Llenando dropdown con ${appState.columns.length} columnas.`); // LOG
                selectElement.disabled = false;
                const placeholderOption = document.createElement('option');
                placeholderOption.value = "";
                placeholderOption.textContent = "Selecciona una columna...";
                placeholderOption.disabled = true;
                placeholderOption.selected = true;
                selectElement.appendChild(placeholderOption);

                appState.columns.forEach(column => {
                    const option = document.createElement('option');
                    option.value = column.id;
                    option.textContent = column.title;
                    selectElement.appendChild(option);
                });
            }
        }


        // --- Manejadores de Eventos ---
        function handleAddBookmark(event) { /* ... sin cambios ... */ }
        function handleAddColumn() { /* ... sin cambios ... */ }
        function handleColumnClick(event) { // A√±adido manejo de Pin
             if (event.target.classList.contains('pin-bookmark-btn')) {
                 togglePinBookmark(event.target.dataset.bookmarkId);
             }
             else if (event.target.classList.contains('delete-bookmark-btn')) { /* ... */ }
             else if (event.target.classList.contains('edit-bookmark-btn')) { /* ... */ }
             else if (event.target.classList.contains('delete-column-btn')) { /* ... */ }
        }
        // --- Pin / Fijar ---
         function togglePinBookmark(bookmarkId) {
             const bookmarkIndex = appState.bookmarks.findIndex(bm => bm.id === bookmarkId);
             if (bookmarkIndex !== -1) {
                 appState.bookmarks[bookmarkIndex].isPinned = !appState.bookmarks[bookmarkIndex].isPinned;
                 sortAppStateBookmarks();
                 renderAllBookmarksInOrder(); // Re-renderizar para mostrar cambio de orden/estilo
                 saveAppState();
             }
         }
        // --- Edici√≥n T√≠tulo Columna ---
        function handleColumnTitleDblClick(event){ /* ... sin cambios ... */ }
        function handleTitleEditEnd(event){ /* ... sin cambios ... */ }
        function handleTitleEditKeydown(event){ /* ... sin cambios ... */ }
        function finishTitleEditing(titleElement, shouldSave = true){ /* ... sin cambios ... */ }
        // --- Edici√≥n Bookmark (Modal) ---
        function openEditModal(bookmarkId) { /* ... sin cambios ... */ }
        function closeModal() { /* ... sin cambios ... */ }
        function handleEditBookmarkSubmit(event) { /* ... sin cambios ... */ }
        // Helper para actualizar DOM de bookmark editado
         function renderSingleBookmarkDOM(bookmarkItemElement, bookmarkData) { /* ... sin cambios ... */ }
        // --- Drag & Drop NATIVO ---
        function handleDragStart(event){ /* ... sin cambios ... */ }
        function handleDragEnd(event){ /* ... sin cambios ... */ }
        function handleDragOver(event){ /* ... sin cambios ... */ }
        function handleDragEnter(event){ /* ... sin cambios ... */ }
        function handleDragLeave(event){ /* ... sin cambios ... */ }
        function handleDrop(event) { // Modificado para re-ordenar antes de guardar/render
             event.preventDefault(); if (!draggedItem) return;
             const targetItem = event.target.closest('.bookmark-item');
             const targetList = event.target.closest('.bookmarks-list');
             if (!targetList || targetList !== draggedItem.closest('.bookmarks-list')) { draggedItem.classList.remove('dragging'); clearDragOverStyles(); draggedItem = null; return; } // Asegurar limpieza si drop es inv√°lido
             clearDragOverStyles();
             if (targetItem && targetItem !== draggedItem) { targetList.insertBefore(draggedItem, targetItem); }
             else { targetList.appendChild(draggedItem); }
             // Sincronizar, Ordenar (pin), Re-renderizar, Guardar
             syncAppStateOrderFromDOM();
             sortAppStateBookmarks();
             renderAllBookmarksInOrder(); // Re-renderizar es crucial aqu√≠ para la consistencia visual post-D&D + Pin
             saveAppState();
             // Limpieza de draggedItem ahora est√° en handleDragEnd
        }
        function clearDragOverStyles(){ /* ... sin cambios ... */ }
        // Helper para sincronizar orden con DOM
        function syncAppStateOrderFromDOM() { /* ... sin cambios ... */ }
        // --- B√∫squeda / Filtrado ---
        function handleSearch(event) { applySearchFilter(); }
        function applySearchFilter() { /* ... sin cambios ... */ }
        // --- Importar / Exportar ---
        function handleExport() { /* ... sin cambios ... */ }
        function handleImportFileChange(event) { /* ... sin cambios ... */ }
        // --- Utilidades ---
        function escapeHTML(str) { /* ... sin cambios ... */ }
        function getColumnTitleById(columnId) { /* ... sin cambios ... */ }

    </script>

</body>
</html>
